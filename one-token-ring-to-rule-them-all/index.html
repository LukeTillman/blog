<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />

  <title>One (Token) Ring to Rule Them All - Luke Tillman</title>
  <meta name="author" content="Luke Tillman" />

  <link rel="alternate" href="/atom.xml" type="application/atom+xml" title="Luke Tillman ATOM Feed" />
  <link rel="shortcut icon" type="image/png" href="/images/favicon.png"/>
  <link rel="prefetch" href="http://www.luketillman.com" />

  <link href="/css/styles.css" rel="stylesheet" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  

<link rel="canonical" href="http://www.luketillman.com/one-token-ring-to-rule-them-all/" />

<meta name="description" content="For newcomers to Cassandra, all the terminology can be a little overwhelming at first. If you have experience with relational databases, some concepts like a &quot;Row&quot; or a &quot;Primary Key&quot; will be familiar. But other terms that seem" />
<meta name="keywords" content="cassandra" />


<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@LukeTillman" />


<meta property="og:title" content="One (Token) Ring to Rule Them All" />
<meta property="og:description" content="For newcomers to Cassandra, all the terminology can be a little overwhelming at first. If you have experience with relational databases, some concepts like a &quot;Row&quot; or a &quot;Primary Key&quot; will be familiar. But other terms that seem" />
<meta property="og:site_name" content="Luke Tillman" />
<meta property="og:url" content="http://www.luketillman.com/one-token-ring-to-rule-them-all/" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-12-09T08:23:34.000Z" />
<meta property="article:modified_time" content="2016-12-09T08:23:34.000Z" />
<meta property="article:author" content="Luke Tillman" />
<meta property="article:tag" content="cassandra" />

<script type="application/ld+json">
  {"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":"http://www.luketillman.com/one-token-ring-to-rule-them-all/","author":{"@type":"Person","name":"Luke Tillman"},"publisher":{"@type":"Person","name":"Luke Tillman"},"headline":"One (Token) Ring to Rule Them All","keywords":"cassandra","description":"For newcomers to Cassandra, all the terminology can be a little overwhelming at first. If you  have experience with relational databases, some concepts like a \"Row\" or a \"Primary Key\" will  be familiar. But other terms that seem","dateModified":"2016-12-09T08:23:34.000Z","datePublished":"2016-12-09T08:23:34.000Z"}
</script>
  
</head>
<body>
  
  <header id="site-header">
    <nav class="nav">
      <div class="container is-fluid">
        <div class="nav-left">
          <span class="nav-item is-brand">
            <a class="button is-dark is-medium" href="/">
              <span class="icon">
                <i class="fa fa-bookmark-o"></i>
              </span>
              <span>Luke Tillman</span>
            </a>
          </span>
        </div>

        
        <span class="nav-toggle">
          <span></span>
          <span></span>
          <span></span>
        </span>

        <div class="nav-right nav-menu">
          <a class="nav-item" href="/about">
            About
          </a>
          <a class="nav-item" href="/contact">
            Contact
          </a>
        </div>
      </div>
    </nav>
  </header>

  <section class="section">
    <div class="container">
      <div class="columns">
        <div class="column is-8 is-offset-2">
          
          
<article class="post">
  
  


<header class="header">
  <ul class="post-tags">
    
    <li class="post-tag">
      <a href="/tags/cassandra/">cassandra</a>
    </li>
    
  </ul>
  <h1 class="title">
    
    
    One (Token) Ring to Rule Them All
    
  </h1>
  <p class="post-metadata">
    Posted on <span class="icon"><i class="fa fa-clock-o"></i></span> 
    <time class="post-time" datetime="2016-12-09T08:23:34.000Z">December 9, 2016</time>
  </p>
</header>

  

  <div class="content post-content">
    <p>For newcomers to Cassandra, all the terminology can be a little overwhelming at first. If you 
have experience with relational databases, some concepts like a &quot;Row&quot; or a &quot;Primary Key&quot; will 
be familiar. But other terms that seem straightforward can often be a little confusing, 
especially when paired with some of the visuals you see when learning about Cassandra.</p>
<p>For example, take a look at this screenshot from the <a href="http://www.datastax.com/products/datastax-enterprise-visual-admin" target="_blank">DataStax OpsCenter</a> management 
tool:</p>
<img src="/one-token-ring-to-rule-them-all/opscenter.png" alt="DataStax OpsCenter screenshot showing the dashboard" title="DataStax OpsCenter screenshot showing the dashboard">
<p>Now answer these questions:</p>
<ul>
<li>How many <strong>token rings</strong> are there?</li>
<li>How many <strong>clusters</strong> are there?</li>
<li>How many <strong>datacenters</strong> are there?</li>
</ul>
<p>How about this slide that I use when introducing new users to Cassandra:</p>
<figure>
  <img src="/one-token-ring-to-rule-them-all/multi-dc.png" alt="Slide with two DCs showing replication between them" title="Slide with two DCs showing replication between them">
  <figcaption>
    <header>Yes, I love 80&#39;s movie references</header>
    How many movie references can you fit in a 40 minute talk? I attempted to find out with my 
    Cassandra Summit 2015 presentation, 
    <a href="http://www.slideshare.net/LukeTillman/relational-scaling-and-the-temple-of-gloom-from-cassandra-summit-2015" target="_blank">Relational Scaling and the Temple of Gloom</a>.
    You&#39;ll find this slide and a whole bunch more there.
  </figcaption>
</figure>

<p>In case you&#39;re wondering, yes, your data actually is &quot;coming to America&quot; in that diagram (pun 
fully intended). Now answer those same questions:</p>
<ul>
<li>How many <strong>token rings</strong> are there?</li>
<li>How many <strong>clusters</strong> are there?</li>
<li>How many <strong>datacenters</strong> are there?</li>
</ul>
<p>Did you answer <strong>two</strong> for all the questions in both pictures? If you did, you wouldn&#39;t be 
alone, but you also wouldn&#39;t be correct either. This is one example where the terminology can 
get a little confusing. Let&#39;s walk through those terms, starting with the last one and working 
our way backwards.</p>
<h2 id="datacenters">Datacenters</h2>
<p>This is the term that most people are familiar with before starting with Cassandra and if you 
answered <strong>two</strong> to the question above then you&#39;re not only correct, but well on your way to 
understanding this concept. In the computing world, we tend to think of a datacenter as a 
physical place where our computers reside. The same can be true for a datacenter in Cassandra, 
but it doesn&#39;t necessarily have to be true.</p>
<p>In Cassandra, a datacenter is just a <em>logical</em> grouping of nodes. This grouping could be based 
on the physical location of your nodes. For example, we might have a <code>us-east</code> and a <code>us-west</code> 
datacenter. But it could also be based on something other than physical location. For example, 
we might set up a <code>transactional</code> and an <code>analytics</code> datacenter to run different types of 
workloads, but the nodes for those datacenters might be <em>physically</em> in the same location.</p>
<p>So how does Cassandra know which nodes belong to which datacenter? Well that&#39;s a little outside 
the scope of this post, but the short answer is a component in Cassandra called a <strong>Snitch</strong>. 
If you want to dig in more, there&#39;s a great explanation of the Snitch on 
<a href="https://academy.datastax.com/courses/ds201-foundations-apache-cassandra/distributed-architecture-snitch" target="_blank">DataStax Academy</a>.</p>
<p>Most of the time when we&#39;re looking at visual depictions of Cassandra like in OpsCenter or my 
slide above, the nodes are being shown grouped by data center.</p>
<h2 id="clusters">Clusters</h2>
<p>If you answered two for this question, I don&#39;t blame you. After all in English, 
<a href="http://www.merriam-webster.com/dictionary/cluster" target="_blank">cluster is defined</a> as &quot;a group of things or people that are close together&quot; and 
in both of those pictures, it sure looks like there are two separate groups of nodes that are 
close together. But as we just established, most of the time when we see pictures like those 
we&#39;re seeing nodes grouped by datacenter.</p>
<p>In Cassandra a cluster refers to all the nodes across all the datacenters that are peers (i.e. 
aware of each other). For both of those images, we&#39;ve got two datacenters where replication is 
happening between the two of them. So while there are two datacenters, there&#39;s only <strong>one</strong> 
cluster depicted in both of those images.</p>
<h2 id="token-rings">Token Rings</h2>
<p>That leaves us with the question about the number of token rings. I tried to be specific by 
asking about <em>token</em> rings instead of just rings. Oftentimes in Cassandra, the term &quot;ring&quot; (by 
itself) is used interchangeably with &quot;cluster&quot; to refer to all the nodes across all the 
datacenters. But when we say token ring we&#39;re usually referring to a specific concept in 
Cassandra--data distribution.</p>
<p>If you&#39;ve been working with Cassandra then you know by now that when you create a table, you 
choose a Primary Key. Part of that Primary Key (usually the first column or sometimes the first 
group of columns) is called the Partition Key. For example, take a look at the 
<a href="https://github.com/KillrVideo/killrvideo-data/blob/master/schema.cql#L9" target="_blank"><code>users</code> table</a> from <a href="https://killrvideo.github.io" target="_blank">KillrVideo</a>:</p>
<pre><code class="hljs">CREATE TABLE users (
  userid uuid,
  firstname text,
  lastname text,
  email text,
  created_date timestamp,
  PRIMARY KEY (userid)
);</code></pre><p>Here, the partition key is the <code>userid</code> column. When we insert data into that table, the value 
for <code>userid</code> is used to determine which nodes in Cassandra will actually store the data. 
Choosing a Primary Key is important but what does this have to do with token rings?</p>
<p>Well when Cassandra wants to know where to place data, it takes your Partition Key value and 
runs it through a <a href="http://docs.datastax.com/en/cassandra/3.x/cassandra/architecture/archDataDistributeHashing.html" target="_blank">consistent hashing</a> function. The hash that comes out of 
this consistent hashing function is sometimes referred to as a token. And in Cassandra, nodes 
in your cluster own ranges (or buckets) of all the possible tokens.</p>
<p>So for example, let&#39;s pretend we have a hashing function that outputs tokens from <code>0</code> to <code>99</code>. 
The distribution of those tokens across all the nodes in an eight node cluster might look 
something like this:</p>
<figure>
  <img src="/one-token-ring-to-rule-them-all/the-ring.png" alt="A cluster of nodes with tokens 0-99 distributed across those nodes" title="A cluster of nodes with tokens 0-99 distributed across those nodes">
  <figcaption>
    <header>Great for Illustration, Not for Production</header>
    While you&#39;d never use a hashing function with so few tokens like this in production, it&#39;s 
    still a great illustration. You&#39;ll find this slide with a lot more detailed explanation in
    the <a href="https://academy.datastax.com/resources/ds201-foundations-apache-cassandra" target="_blank">DS201: Foundations of Apache Cassandra</a>
    course.
  </figcaption>
</figure>

<p>Now this is a really simplified example because of the small range of tokens available. In real 
Cassandra deployments, most people stick with the default <a href="http://docs.datastax.com/en/cassandra/3.x/cassandra/architecture/archPartitionerM3P.html" target="_blank">Murmur3 partitioner</a> which 
outputs tokens in the range of <code>-2<sup>63</sup></code> to <code>2<sup>63</sup> - 1</code>, 
but even with the larger range available, the principle is the same.</p>
<p>The total range of available tokens and their distribution around the cluster is often referred 
to as the token ring in Cassandra. And that range of tokens is distributed around the <em>cluster</em> 
with each node owning a portion of the token ring. So even if we took our 8 node cluster above 
and logically grouped the nodes across two datacenters, there would still only be one token 
ring.</p>
<p>This can be really hard to wrap your brain around, especially when you see pictures like the 
two above. In those pictures, there are definitely two &quot;rings&quot; in the English sense of the 
word. But in Cassandra terms there&#39;s only <em>one</em> token ring (and only one &quot;ring&quot; if we&#39;re using 
that term interchangeably with &quot;cluster&quot;), even if the nodes are grouped and displayed as two 
datacenters.</p>
<h2 id="conclusion">Conclusion</h2>
<p>If you&#39;re struggling with some of the terminology when getting started with Cassandra, 
hopefully this helps to clear some things up. I highly recommend checking out 
<a href="https://academy.datastax.com/resources/ds201-foundations-apache-cassandra" target="_blank">DS201: Foundations of Apache Cassandra</a> on DataStax Academy for a deeper dive into 
many of these concepts. Things like replication (and replication strategies) are all built on 
top of this foundation, so understanding these concepts can go a long way towards becoming a 
Cassandra guru.</p>

  </div>

  
  <ul class="post-tags has-text-right">
    
    <li class="post-tag">
      <a href="/tags/cassandra/" class="button is-light">cassandra</a>
    </li>
    
  </ul>

  
  
    <div class="notification is-small is-info has-title">
      <span class="notification-title">Note</span>
      <span class="notification-message">This blog post originally appeared on Planet Cassandra in April 2016 before that site was  donated to the Apache Foundation and all the content was removed. I&#39;ve reposted it here to preserve the content.
</span>
    </div>
  

  
  <footer class="post-footer">
    <div class="media bio">
      <figure class="media-left">
        <p class="image is-128x128">
          <img src="/images/luke.jpg" alt="Luke Tillman">
        </p>
      </figure>
      <div class="media-content">
        <h4 class="title is-4">
          Luke Tillman
        </h4>
        <p class="bio-text">
          Luke is an engineer, soccer fan, political junkie, and lover of all nerdery. He&#39;s currently employed as  a Technical Evangelist at DataStax where he frequently works with Cassandra, .NET, and Node.js.

        </p>
        <p class="bio-text">
          
  <a href="https://twitter.com/LukeTillman" target="_blank" class="social-button twitter is-color">
    <span class="icon">
      <i class="fa fa-twitter"></i>
    </span>
  </a>
  <a href="https://github.com/LukeTillman" target="_blank" class="social-button github is-color">
    <span class="icon">
      <i class="fa fa-github"></i>
    </span>
  </a>
  <a href="/atom.xml" target="_blank" class="social-button rss is-color">
    <span class="icon">
      <i class="fa fa-rss"></i>
    </span>
  </a>
  <a href="https://plus.google.com/+LukeTillman1" target="_blank" class="social-button google-plus is-color">
    <span class="icon">
      <i class="fa fa-google-plus"></i>
    </span>
  </a>
  <a href="https://www.linkedin.com/in/luketillman" target="_blank" class="social-button linkedin is-color">
    <span class="icon">
      <i class="fa fa-linkedin"></i>
    </span>
  </a>

        </p>
      </div>
    </div>
  </footer>
</article>

        </div>
        <div class="column sidebar-column">
          
          
<aside class="sidebar bio">
  <p class="image is-128x128">
    <img src="/images/luke.jpg" alt="Luke Tillman">
  </p>

  <h4 class="title is-4">
    Luke Tillman
  </h4>

  <p class="bio-text">
    
  <a href="https://twitter.com/LukeTillman" target="_blank" class="social-button twitter is-small">
    <span class="icon">
      <i class="fa fa-twitter"></i>
    </span>
  </a>
  <a href="https://github.com/LukeTillman" target="_blank" class="social-button github is-small">
    <span class="icon">
      <i class="fa fa-github"></i>
    </span>
  </a>
  <a href="/atom.xml" target="_blank" class="social-button rss is-small">
    <span class="icon">
      <i class="fa fa-rss"></i>
    </span>
  </a>
  <a href="https://plus.google.com/+LukeTillman1" target="_blank" class="social-button google-plus is-small">
    <span class="icon">
      <i class="fa fa-google-plus"></i>
    </span>
  </a>
  <a href="https://www.linkedin.com/in/luketillman" target="_blank" class="social-button linkedin is-small">
    <span class="icon">
      <i class="fa fa-linkedin"></i>
    </span>
  </a>

  </p>

  <p class="bio-text">
    Luke is an engineer, soccer fan, political junkie, and lover of all nerdery. He&#39;s currently employed as  a Technical Evangelist at DataStax where he frequently works with Cassandra, .NET, and Node.js.

  </p>
</aside>

        </div>
      </div>
    </div>
  </section>

  
  <footer id="site-footer" class="section">
    <div class="container">
      <div class="columns">
        <div class="column is-8 is-offset-2">
          Copyright &copy; <a class="link" href="http://www.luketillman.com">Luke Tillman</a>. 2016 &bull; 
          All rights reserved.
        </div>
      </div>
    </div>
  </footer>

  
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-49061569-1', 'auto');
    ga('send', 'pageview');
  </script>
  
</body>
</html>